---
title: "FTM-vignette"
author: "Corey Giles & Changyu Yi"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{FTM-vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

This package enables users to adapt linear model (lm), generalized linear mode (glm), and glmnet model to the Flexible Transfer Models (FTM) framework. This allows models to be evaluated in datasets without exact overlap in the predictor variables, without loss in generalizability, re-optimization or access to individual-level data. It leverages an innovative matrix-based approach to re-estimate model parameters (beta coefficients) using both full and reduced sets of predictor variables, enhancing the transferrability of prediction models across different datasets.

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Install and load the package

The package can be installed using code below, note that you'll need to install [glmnet](https://glmnet.stanford.edu/articles/glmnet.html) package if you haven't.

```{r message=FALSE, warning=FALSE}
## install the paclage
# devtools::install_github("BakerMetabolomics/FlexibleTransferModels")

## load packages
library(glmnet)
#library(FlexibleTransferModels)
library(FTM)
```

# Create FTM objects

FTM object can be created from lm, glm and glmnet models using `createFTM` function. You can also use more specific functions to create FTM objects, e.g. use `createFromLm` to create FTM object from a lm object.

## Create FTM object from linear model
Here is how to create FTM object from a linear model.

```{r}
data(mtcars)

# Fitting a linear model to the mtcars dataset
lm_model <- lm(mpg ~ cyl + hp + wt, data = mtcars)

# Create FTM object using createFromLm
ftmlm_model <- createFromLm(lm_model)

# Create FTM object using createFTM
ftmlm_model <- createFTM(lm_model) # same as using createFromLm

# quick look at the model
show(ftmlm_model)
```


## Create FTM object from gernalized linear model
Here is how to create FTM object from a generalized linear model.

```{r}
# Fitting a glm to the mtcars dataset
glm_model <- glm(am ~ hp + wt + cyl, data = mtcars, family = "binomial")

# Create FTM object using createFromGlm
ftmglm_model <- createFromGlm(glm_model)

# Create FTM object using createFTM
ftmglm_model <- createFTM(glm_model)

# quick look at the model
show(ftmglm_model)
```

## Create FTM object from glmnet model
Here is how to create FTM object from a glmnet model.

```{r}
# set the predictors
predictors <- as.matrix(mtcars[, c("hp", "wt", "cyl")])

# Fitting a glmnet to the mtcars dataset
glmnet_model <- glmnet::cv.glmnet(predictors, mtcars$am, family = "binomial")

# Create FTM object using createFromGlmnet
ftmglmnet_model <- createFromGlmnet(glmnet_model, x = predictors, y = mtcars$am)

# Create FTM object using createFTM
ftmglmnet_model <- createFTM(glmnet_model, x = predictors, y = mtcars$am)

# quick look at the model
show(ftmglmnet_model)
```

# Extract the beta coefficient from FTM object

You can extract beta coefficient for all variables or a set of variables that you are interested.

```{r}
# Assuming ftmglm_model, ftmlm_model or ftmglmnet_model are pre-fitted model objects

# Extract coefficients for all variables from a ftmlm model
coeffs_lm<- coef(ftmlm_model)
coeffs_lm

# Extract all coefficients specific variables from a ftmlm model
coeffs_lm_select <- coef(ftmlm_model, select = c("cyl", "hp"))



# Extract all coefficients from a ftmglm model
coeffs_glm <- coef(ftmglm_model)
coeffs_glm

# Extract coefficients for specific variables from a ftmglm model
coeffs_glm_select <- coef(ftmglm_model, select = c("cyl", "hp"))



# Extract all coefficients from a ftmglmnet model
coeffs_glmnet <- coef(ftmglmnet_model)
coeffs_glmnet

# Extract coefficients for specific variables from a ftmglmnet model
coeffs_glmnet_select <- coef(ftmglmnet_model, select = c("cyl", "hp"))
```

# Apply the model to new datasets to predict the outcome
Now we can predict the outcome in the new datasets without exact overlaping predictor variables

```{r}
# Predict on "new" data
new_data <- mtcars[1:10, c("hp", "wt", "cyl")]

# predict using the FTM from lm model
predictions <- predict(ftmlm_model, newdata = new_data)
predictions

# predict using the FTM from glm model
predictions <- predict(ftmglm_model, newdata = new_data)
predictions

# predict using the FTM from glmnet model
predictions <- predict(ftmglmnet_model, newdata = new_data)
predictions
```















